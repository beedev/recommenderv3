
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="AI-powered welding equipment configurator - Technical documentation">
      
      
        <meta name="author" content="ESAB Development Team">
      
      
        <link rel="canonical" href="https://esab-configurator.readthedocs.io/archive/DATABASE_CONNECTION_AUDIT/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Database Connection Management Audit - ESAB Configurator Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#database-connection-management-audit" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ESAB Configurator Documentation" class="md-header__button md-logo" aria-label="ESAB Configurator Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ESAB Configurator Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Database Connection Management Audit
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/esab/configurator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    esab-configurator
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../CODE_ARCHITECTURE_OVERVIEW/" class="md-tabs__link">
          
  
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../deployment/README.md" class="md-tabs__link">
          
  
  
  Operations

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ESAB Configurator Documentation" class="md-nav__button md-logo" aria-label="ESAB Configurator Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ESAB Configurator Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/esab/configurator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    esab-configurator
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CODE_ARCHITECTURE_OVERVIEW/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CORRECTED_STATE_FLOW_ARCHITECTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    State Flow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ORCHESTRATOR_ARCHITECTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Orchestrator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CONTEXT_BASED_STRATEGIES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Search Strategies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../MASTER_PARAMETER_JSON_ARCHITECTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Master Parameter JSON
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../MULTILINGUAL_FLOW/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multilingual Flow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    System Components
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    System Components
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CONFIGURATION_SYSTEM/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../OBSERVABILITY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Observability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Operations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Operations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/README.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing-guide.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/runbook.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Operations Runbook
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="database-connection-management-audit">Database Connection Management Audit<a class="headerlink" href="#database-connection-management-audit" title="Permanent link">&para;</a></h1>
<p><strong>Date</strong>: 2025-11-16
<strong>Status</strong>: üö® Critical Issues Identified
<strong>Priority</strong>: High - Connection leaks and no resilience for dropped connections</p>
<hr />
<h2 id="executive-summary">Executive Summary<a class="headerlink" href="#executive-summary" title="Permanent link">&para;</a></h2>
<p>This audit identifies critical issues in how Neo4j connections are managed across the codebase. While Redis and PostgreSQL follow best practices with centralized managers, Neo4j connections are scattered across multiple files with <strong>no centralized management, no connection pooling coordination, and no automatic recovery from dropped connections</strong>.</p>
<p><strong>Key Findings</strong>:
- ‚úÖ <strong>Redis</strong>: Centralized, well-managed via <code>RedisManager</code>
- ‚úÖ <strong>PostgreSQL</strong>: Centralized via <code>PostgreSQLManager</code>
- ‚ùå <strong>Neo4j</strong>: Decentralized, multiple driver instances, potential connection leaks</p>
<hr />
<h2 id="1-neo4j-connection-issues">1. Neo4j Connection Issues<a class="headerlink" href="#1-neo4j-connection-issues" title="Permanent link">&para;</a></h2>
<h3 id="11-decentralized-driver-creation">1.1 Decentralized Driver Creation<a class="headerlink" href="#11-decentralized-driver-creation" title="Permanent link">&para;</a></h3>
<p><strong>Problem</strong>: Multiple files create their own Neo4j driver instances, leading to:
- No connection pooling coordination
- Increased memory usage (each driver maintains its own pool)
- Potential connection leaks if cleanup fails
- Inconsistent connection configuration</p>
<p><strong>Files Creating Neo4j Drivers</strong> (20+ files):</p>
<h4 id="production-code">Production Code:<a class="headerlink" href="#production-code" title="Permanent link">&para;</a></h4>
<ol>
<li><strong><code>app/services/neo4j/product_search.py</code></strong> (Lines 45-51)
   <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize Neo4j connection and ComponentSearchService&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">AsyncGraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">component_service</span> <span class="o">=</span> <span class="n">ComponentSearchService</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close Neo4j connection&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></li>
<li><strong>Issue</strong>: Each instance creates its own driver</li>
<li><strong>Impact</strong>: Multiple driver pools in same application</li>
<li>
<p><strong>Status</strong>: Has close() method but no error handling</p>
</li>
<li>
<p><strong><code>app/services/search/strategies/vector_strategy.py</code></strong> (Lines 56-64)
   <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># Initialize Neo4j driver</span>
<span class="n">NEO4J_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NEO4J_URI&quot;</span><span class="p">)</span>
<span class="n">NEO4J_USERNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NEO4J_USERNAME&quot;</span><span class="p">,</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">)</span>
<span class="n">NEO4J_PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NEO4J_PASSWORD&quot;</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">neo4j_driver</span> <span class="o">=</span> <span class="n">AsyncGraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span>
    <span class="n">NEO4J_URI</span><span class="p">,</span>
    <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">NEO4J_USERNAME</span><span class="p">,</span> <span class="n">NEO4J_PASSWORD</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li><strong>Issue</strong>: Creates REDUNDANT driver even though it receives <code>neo4j_product_search</code> parameter</li>
<li><strong>Impact</strong>: Double driver overhead for same service</li>
<li>
<p><strong>Status</strong>: Has close() method (line 281) but redundant initialization</p>
</li>
<li>
<p><strong><code>app/services/search/components/component_service.py</code></strong> (Line 40)
   <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="n">AsyncGraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize component search service.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li><strong>Status</strong>: ‚úÖ <strong>GOOD PATTERN</strong> - Receives driver via dependency injection</li>
<li><strong>No Issues</strong>: Does NOT create its own driver</li>
</ol>
<h4 id="test-files-17-files">Test Files (17+ files):<a class="headerlink" href="#test-files-17-files" title="Permanent link">&para;</a></h4>
<p>All test files in <code>tests/manual/</code> and <code>tests/e2e/</code> create their own drivers:
- <code>check_specific_product.py</code>
- <code>check_attribute_ruleset.py</code>
- <code>test_competitor_fields.py</code>
- <code>test_accessories_lucene.py</code>
- <code>test_torch_relationships.py</code>
- ... and 12+ more</p>
<p><strong>Test Pattern</strong>:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">driver</span> <span class="o">=</span> <span class="n">AsyncGraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span><span class="n">NEO4J_URI</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">NEO4J_USERNAME</span><span class="p">,</span> <span class="n">NEO4J_PASSWORD</span><span class="p">))</span>
<span class="c1"># ... tests ...</span>
<span class="k">await</span> <span class="n">driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
- <strong>Impact</strong>: Each test creates isolated driver (acceptable for tests)
- <strong>Issue</strong>: If test fails before close(), connection leaks</p>
<h3 id="12-connection-lifecycle-issues">1.2 Connection Lifecycle Issues<a class="headerlink" href="#12-connection-lifecycle-issues" title="Permanent link">&para;</a></h3>
<p><strong>Current Lifecycle</strong>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code>Startup (main.py:218-226):
  neo4j_search = Neo4jProductSearch(
      uri=neo4j_uri,
      username=neo4j_username,
      password=neo4j_password
  )
  ‚Üí Creates driver instance internally

Runtime:
  - No connection health checks
  - No automatic reconnection on dropped connections
  - No connection pool monitoring

Shutdown (main.py:362-365):
  if neo4j_search:
      await neo4j_search.close()
  ‚Üí Only closes global neo4j_search instance
  ‚Üí Does NOT close VectorStrategy&#39;s redundant driver
</code></pre></div></td></tr></table></div>
<p><strong>Issues Identified</strong>:</p>
<ol>
<li><strong>No Dropped Connection Handling</strong>:</li>
<li>If Neo4j connection drops during runtime, queries will fail</li>
<li>No automatic retry or reconnection logic</li>
<li>
<p>Driver configuration doesn't specify connection timeouts or max retries</p>
</li>
<li>
<p><strong>Incomplete Cleanup</strong>:</p>
</li>
<li>Only <code>neo4j_search</code> is closed in lifespan shutdown</li>
<li><code>VectorStrategy</code> driver (created in strategies) is NEVER closed</li>
<li>
<p>Strategy instances created in orchestrator not tracked for cleanup</p>
</li>
<li>
<p><strong>No Connection Health Monitoring</strong>:</p>
</li>
<li>No periodic health checks</li>
<li>No metrics on connection pool usage</li>
<li>Can't detect connection issues proactively</li>
</ol>
<h3 id="13-vectorstrategy-redundant-driver-issue">1.3 VectorStrategy Redundant Driver Issue<a class="headerlink" href="#13-vectorstrategy-redundant-driver-issue" title="Permanent link">&para;</a></h3>
<p><strong>Critical Issue</strong>: <code>vector_strategy.py</code> creates its own driver even though it receives <code>neo4j_product_search</code> which already has a driver.</p>
<p><strong>Current Code</strong> (Lines 48-77):
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">neo4j_product_search</span><span class="p">,</span>  <span class="c1"># ‚Üê Receives this</span>
    <span class="n">openai_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncOpenAI</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Initialize Neo4j driver (REDUNDANT!)</span>
    <span class="n">NEO4J_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NEO4J_URI&quot;</span><span class="p">)</span>
    <span class="n">NEO4J_USERNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NEO4J_USERNAME&quot;</span><span class="p">,</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">)</span>
    <span class="n">NEO4J_PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NEO4J_PASSWORD&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">neo4j_driver</span> <span class="o">=</span> <span class="n">AsyncGraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span>  <span class="c1"># ‚Üê Creates ANOTHER driver</span>
        <span class="n">NEO4J_URI</span><span class="p">,</span>
        <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">NEO4J_USERNAME</span><span class="p">,</span> <span class="n">NEO4J_PASSWORD</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
<p><strong>Why Redundant</strong>:
- <code>neo4j_product_search</code> already has <code>self.driver</code> (created in its <code>__init__</code>)
- VectorStrategy could use <code>neo4j_product_search.driver</code> directly
- No need for separate driver instance</p>
<p><strong>Impact</strong>:
- 2x driver overhead (2 connection pools)
- 2x memory usage for connection management
- One driver is NEVER closed (no reference in main.py shutdown)</p>
<hr />
<h2 id="2-redis-connection-status">2. Redis Connection Status ‚úÖ<a class="headerlink" href="#2-redis-connection-status" title="Permanent link">&para;</a></h2>
<p><strong>Verdict</strong>: Redis follows best practices with centralized management.</p>
<h3 id="21-centralized-manager-pattern">2.1 Centralized Manager Pattern<a class="headerlink" href="#21-centralized-manager-pattern" title="Permanent link">&para;</a></h3>
<p><strong>File</strong>: <code>app/database/database.py</code> (Lines 18-87)</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RedisManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Redis manager for hot session data and LangGraph checkpoints.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;REDIS_URL&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_host</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;REDIS_HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;REDIS_PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;6379&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;REDIS_PASSWORD&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Redis</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init_redis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize Redis connection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">Redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_url</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_host</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_port</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_password</span><span class="p">,</span>
                <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>  <span class="c1"># ‚úÖ Connection health check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close Redis connection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Global singleton instance</span>
<span class="n">redis_manager</span> <span class="o">=</span> <span class="n">RedisManager</span><span class="p">()</span>

<span class="c1"># Dependency injection</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_redis_client</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Redis</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">redis_manager</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">redis_manager</span><span class="o">.</span><span class="n">init_redis</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redis_manager</span><span class="o">.</span><span class="n">client</span>
</code></pre></div></td></tr></table></div>
<p><strong>Strengths</strong>:
- ‚úÖ Singleton pattern (one connection pool)
- ‚úÖ Lazy initialization
- ‚úÖ Connection health check (<code>ping()</code>)
- ‚úÖ Dependency injection for FastAPI
- ‚úÖ Proper cleanup with <code>close()</code>
- ‚úÖ Integrated with lifespan manager (main.py:351)</p>
<h3 id="22-lifespan-integration">2.2 Lifespan Integration<a class="headerlink" href="#22-lifespan-integration" title="Permanent link">&para;</a></h3>
<p><strong>Startup</strong> (main.py:191):
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">await</span> <span class="n">init_redis</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úì Redis initialized&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
<p><strong>Shutdown</strong> (main.py:351-354):
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">close_redis</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úì Redis closed&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing Redis: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
<p><strong>Status</strong>: ‚úÖ Properly integrated, error handling in place</p>
<h3 id="23-potential-improvements">2.3 Potential Improvements<a class="headerlink" href="#23-potential-improvements" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Reconnection Logic</strong>: Add automatic retry on connection failures</li>
<li><strong>Connection Pool Monitoring</strong>: Track pool usage metrics</li>
<li><strong>Circuit Breaker</strong>: Prevent cascading failures if Redis is down</li>
</ol>
<hr />
<h2 id="3-postgresql-connection-status">3. PostgreSQL Connection Status ‚úÖ<a class="headerlink" href="#3-postgresql-connection-status" title="Permanent link">&para;</a></h2>
<p><strong>Verdict</strong>: PostgreSQL follows same centralized pattern as Redis.</p>
<h3 id="31-manager-implementation">3.1 Manager Implementation<a class="headerlink" href="#31-manager-implementation" title="Permanent link">&para;</a></h3>
<p><strong>File</strong>: <code>app/database/database.py</code> (Lines 90-201)</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PostgreSQLManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PostgreSQL manager for archival storage.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncpg</span><span class="o">.</span><span class="n">Pool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># ... config ...</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init_postgresql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize PostgreSQL connection pool.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncpg</span><span class="o">.</span><span class="n">create_pool</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
            <span class="n">min_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">max_size</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>

        <span class="c1"># Test connection</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchval</span><span class="p">(</span><span class="s1">&#39;SELECT 1&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close PostgreSQL connection pool.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Global singleton</span>
<span class="n">postgresql_manager</span> <span class="o">=</span> <span class="n">PostgreSQLManager</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p><strong>Strengths</strong>:
- ‚úÖ Connection pooling (min_size=2, max_size=10)
- ‚úÖ Health check on initialization
- ‚úÖ Proper cleanup
- ‚úÖ Integrated with lifespan manager</p>
<hr />
<h2 id="4-proposed-solution-neo4jmanager">4. Proposed Solution: Neo4jManager<a class="headerlink" href="#4-proposed-solution-neo4jmanager" title="Permanent link">&para;</a></h2>
<h3 id="41-design-goals">4.1 Design Goals<a class="headerlink" href="#41-design-goals" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Centralized Management</strong>: Single driver instance for entire application</li>
<li><strong>Connection Pooling</strong>: Coordinate connection pool usage</li>
<li><strong>Automatic Reconnection</strong>: Retry failed connections with exponential backoff</li>
<li><strong>Health Monitoring</strong>: Periodic health checks and metrics</li>
<li><strong>Dependency Injection</strong>: FastAPI-compatible pattern</li>
<li><strong>Lifespan Integration</strong>: Proper startup/shutdown hooks</li>
</ol>
<h3 id="42-implementation-plan">4.2 Implementation Plan<a class="headerlink" href="#42-implementation-plan" title="Permanent link">&para;</a></h3>
<p><strong>File</strong>: Create <code>app/database/neo4j_manager.py</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Neo4j Connection Manager</span>

<span class="sd">Centralized Neo4j driver management with:</span>
<span class="sd">- Singleton pattern for single driver instance</span>
<span class="sd">- Connection pooling with health checks</span>
<span class="sd">- Automatic reconnection on dropped connections</span>
<span class="sd">- Dependency injection for FastAPI</span>
<span class="sd">- Lifespan integration for proper cleanup</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neo4j</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncGraphDatabase</span><span class="p">,</span> <span class="n">AsyncDriver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neo4j.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ServiceUnavailable</span><span class="p">,</span> <span class="n">SessionExpired</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Neo4jManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Centralized Neo4j driver manager.</span>

<span class="sd">    Provides:</span>
<span class="sd">    - Single driver instance (singleton pattern)</span>
<span class="sd">    - Connection pooling coordination</span>
<span class="sd">    - Health checks and monitoring</span>
<span class="sd">    - Automatic reconnection on failures</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncDriver</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_reconnect_attempts</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c1"># Connection pool configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_connection_lifetime</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 1 hour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_connection_pool_size</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_acquisition_timeout</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># seconds</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init_neo4j</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Neo4j driver with connection pooling.</span>

<span class="sd">        Args:</span>
<span class="sd">            uri: Neo4j connection URI (bolt:// or neo4j://)</span>
<span class="sd">            username: Neo4j username</span>
<span class="sd">            password: Neo4j password</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Neo4j already initialized&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create driver with connection pool configuration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">AsyncGraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span>
                <span class="n">uri</span><span class="p">,</span>
                <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">),</span>
                <span class="n">max_connection_lifetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_connection_lifetime</span><span class="p">,</span>
                <span class="n">max_connection_pool_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_connection_pool_size</span><span class="p">,</span>
                <span class="n">connection_acquisition_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_acquisition_timeout</span><span class="p">,</span>
                <span class="c1"># Enable automatic session management</span>
                <span class="n">encrypted</span><span class="o">=</span><span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;neo4j+s://&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;bolt+s://&quot;</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Health check - verify connection</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_connectivity</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_attempts</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Neo4j driver initialized - URI: </span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Connection pool: max_size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_connection_pool_size</span><span class="si">}</span><span class="s2">, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;max_lifetime=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_connection_lifetime</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Failed to initialize Neo4j driver: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_verify_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify Neo4j connection with simple query.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception if connection fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Driver not initialized&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;RETURN 1 as test&quot;</span><span class="p">)</span>
                <span class="n">record</span> <span class="o">=</span> <span class="k">await</span> <span class="n">result</span><span class="o">.</span><span class="n">single</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Neo4j connectivity verified&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Neo4j connectivity check failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncDriver</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Neo4j driver instance with automatic reconnection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AsyncDriver instance</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError if driver not initialized or reconnection fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Neo4j driver not initialized. Call init_neo4j() first.&quot;</span><span class="p">)</span>

        <span class="c1"># Check if driver is still connected</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_connectivity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_attempts</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Reset on success</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">ServiceUnavailable</span><span class="p">,</span> <span class="n">SessionExpired</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è Neo4j connection lost: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Attempt reconnection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_attempts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_reconnect_attempts</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîÑ Attempting reconnection (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_attempts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_reconnect_attempts</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Max reconnection attempts (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_reconnect_attempts</span><span class="si">}</span><span class="s2">) exceeded&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Neo4j connection lost and reconnection failed&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to reconnect to Neo4j with exponential backoff.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_attempts</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Exponential backoff</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_attempts</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>  <span class="c1"># Max 30 seconds</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2">s before reconnection attempt...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Close existing driver</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Reinitialize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_neo4j</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Neo4j reconnection successful&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Reconnection attempt failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close Neo4j driver and cleanup resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Neo4j driver closed&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing Neo4j driver: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_attempts</span> <span class="o">=</span> <span class="mi">0</span>


<span class="c1"># Global singleton instance</span>
<span class="n">neo4j_manager</span> <span class="o">=</span> <span class="n">Neo4jManager</span><span class="p">()</span>


<span class="c1"># FastAPI dependency injection</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_neo4j_driver</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AsyncDriver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get Neo4j driver for dependency injection.</span>

<span class="sd">    Usage in FastAPI routes:</span>
<span class="sd">        @app.get(&quot;/products&quot;)</span>
<span class="sd">        async def get_products(driver: AsyncDriver = Depends(get_neo4j_driver)):</span>
<span class="sd">            async with driver.session() as session:</span>
<span class="sd">                ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">neo4j_manager</span><span class="o">.</span><span class="n">get_driver</span><span class="p">()</span>


<span class="c1"># Initialization and cleanup functions</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init_neo4j</span><span class="p">(</span><span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize Neo4j manager - called in lifespan startup&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">neo4j_manager</span><span class="o">.</span><span class="n">init_neo4j</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close_neo4j</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close Neo4j manager - called in lifespan shutdown&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">neo4j_manager</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h3 id="43-migration-steps">4.3 Migration Steps<a class="headerlink" href="#43-migration-steps" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong>: Add Neo4jManager to <code>database.py</code></p>
<p><strong>Step 2</strong>: Update <code>main.py</code> lifespan</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Application lifespan manager&quot;&quot;&quot;</span>

    <span class="c1"># Startup</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting application...&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize Neo4j FIRST (centralized)</span>
    <span class="k">await</span> <span class="n">init_neo4j</span><span class="p">(</span><span class="n">neo4j_uri</span><span class="p">,</span> <span class="n">neo4j_username</span><span class="p">,</span> <span class="n">neo4j_password</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úì Neo4j initialized&quot;</span><span class="p">)</span>

    <span class="c1"># Create services using centralized driver</span>
    <span class="k">global</span> <span class="n">parameter_extractor</span><span class="p">,</span> <span class="n">neo4j_search</span><span class="p">,</span> <span class="n">message_generator</span><span class="p">,</span> <span class="n">orchestrator</span>

    <span class="n">neo4j_driver</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_neo4j_driver</span><span class="p">()</span>
    <span class="n">neo4j_search</span> <span class="o">=</span> <span class="n">Neo4jProductSearch</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="n">neo4j_driver</span><span class="p">)</span>  <span class="c1"># Modified constructor</span>
    <span class="c1"># ... other services ...</span>

    <span class="k">yield</span>  <span class="c1"># Application runs</span>

    <span class="c1"># Shutdown</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shutting down...&quot;</span><span class="p">)</span>

    <span class="c1"># Close Neo4j LAST (after all services)</span>
    <span class="k">await</span> <span class="n">close_neo4j</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úì Neo4j closed&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p><strong>Step 3</strong>: Refactor <code>Neo4jProductSearch</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># OLD (creates own driver)</span>
<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">AsyncGraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

<span class="c1"># NEW (receives driver)</span>
<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="n">AsyncDriver</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span>
    <span class="c1"># No close() method needed - manager handles it</span>
</code></pre></div></td></tr></table></div>
<p><strong>Step 4</strong>: Fix <code>VectorSearchStrategy</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># REMOVE redundant driver creation</span>
<span class="c1"># self.neo4j_driver = AsyncGraphDatabase.driver(...)</span>

<span class="c1"># USE product_search&#39;s driver instead</span>
<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">neo4j_product_search</span><span class="p">,</span>
    <span class="n">openai_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncOpenAI</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">neo4j_driver</span> <span class="o">=</span> <span class="n">neo4j_product_search</span><span class="o">.</span><span class="n">driver</span>  <span class="c1"># Reuse existing driver</span>
</code></pre></div></td></tr></table></div>
<p><strong>Step 5</strong>: Update tests to use centralized manager</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># OLD (each test creates driver)</span>
<span class="n">driver</span> <span class="o">=</span> <span class="n">AsyncGraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># NEW (use manager)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.database.neo4j_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">neo4j_manager</span><span class="p">,</span> <span class="n">get_neo4j_driver</span>

<span class="k">await</span> <span class="n">neo4j_manager</span><span class="o">.</span><span class="n">init_neo4j</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<span class="n">driver</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_neo4j_driver</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="5-benefits-of-proposed-solution">5. Benefits of Proposed Solution<a class="headerlink" href="#5-benefits-of-proposed-solution" title="Permanent link">&para;</a></h2>
<h3 id="51-performance-benefits">5.1 Performance Benefits<a class="headerlink" href="#51-performance-benefits" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Reduced Memory</strong>: Single driver pool instead of multiple</li>
<li><strong>Better Resource Utilization</strong>: Coordinated connection pooling</li>
<li><strong>Faster Recovery</strong>: Automatic reconnection on dropped connections</li>
</ul>
<h3 id="52-reliability-benefits">5.2 Reliability Benefits<a class="headerlink" href="#52-reliability-benefits" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>No Connection Leaks</strong>: Centralized cleanup</li>
<li><strong>Health Monitoring</strong>: Periodic connectivity checks</li>
<li><strong>Resilience</strong>: Automatic retry with exponential backoff</li>
</ul>
<h3 id="53-maintainability-benefits">5.3 Maintainability Benefits<a class="headerlink" href="#53-maintainability-benefits" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Consistent Pattern</strong>: Same as Redis/PostgreSQL</li>
<li><strong>Easier Testing</strong>: Mock single manager instead of multiple drivers</li>
<li><strong>Better Debugging</strong>: Centralized logging and metrics</li>
</ul>
<hr />
<h2 id="6-testing-plan">6. Testing Plan<a class="headerlink" href="#6-testing-plan" title="Permanent link">&para;</a></h2>
<h3 id="61-unit-tests">6.1 Unit Tests<a class="headerlink" href="#61-unit-tests" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># tests/unit/database/test_neo4j_manager.py</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_neo4j_manager_initialization</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test manager initializes correctly&quot;&quot;&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">Neo4jManager</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">init_neo4j</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">manager</span><span class="o">.</span><span class="n">_initialized</span>
    <span class="k">assert</span> <span class="n">manager</span><span class="o">.</span><span class="n">driver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_neo4j_manager_reconnection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test automatic reconnection on dropped connection&quot;&quot;&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">Neo4jManager</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">init_neo4j</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="c1"># Simulate connection drop</span>
    <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Should automatically reconnect</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_driver</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">driver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h3 id="62-integration-tests">6.2 Integration Tests<a class="headerlink" href="#62-integration-tests" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># tests/integration/test_neo4j_connection.py</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_services_share_driver</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that all services use same driver instance&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">init_neo4j</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="n">driver1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_neo4j_driver</span><span class="p">()</span>
    <span class="n">driver2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_neo4j_driver</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">driver1</span> <span class="ow">is</span> <span class="n">driver2</span>  <span class="c1"># Same instance</span>

    <span class="k">await</span> <span class="n">close_neo4j</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="7-implementation-priority">7. Implementation Priority<a class="headerlink" href="#7-implementation-priority" title="Permanent link">&para;</a></h2>
<p><strong>Priority</strong>: üö® <strong>HIGH</strong> - Connection leaks and no resilience</p>
<p><strong>Timeline</strong>:
1. Week 1: Implement Neo4jManager (2-3 days)
2. Week 1: Update main.py and core services (1-2 days)
3. Week 2: Refactor tests and verify (2-3 days)
4. Week 2: Production testing and monitoring (2 days)</p>
<p><strong>Risk</strong>: Low - Backward compatible if done incrementally</p>
<hr />
<h2 id="8-recommendations">8. Recommendations<a class="headerlink" href="#8-recommendations" title="Permanent link">&para;</a></h2>
<h3 id="immediate-actions-this-week">Immediate Actions (This Week):<a class="headerlink" href="#immediate-actions-this-week" title="Permanent link">&para;</a></h3>
<ol>
<li>‚úÖ <strong>Implement Neo4jManager</strong> following Redis pattern</li>
<li>‚úÖ <strong>Update main.py lifespan</strong> to use centralized driver</li>
<li>‚úÖ <strong>Fix VectorStrategy redundancy</strong> - reuse product_search driver</li>
<li>‚úÖ <strong>Add connection health checks</strong> with automatic retry</li>
</ol>
<h3 id="short-term-next-sprint">Short-term (Next Sprint):<a class="headerlink" href="#short-term-next-sprint" title="Permanent link">&para;</a></h3>
<ol>
<li>‚ö° <strong>Add metrics and monitoring</strong> for connection pool usage</li>
<li>‚ö° <strong>Implement circuit breaker</strong> for resilience</li>
<li>‚ö° <strong>Update all test files</strong> to use manager</li>
<li>‚ö° <strong>Add connection pool size tuning</strong> based on load</li>
</ol>
<h3 id="long-term-next-quarter">Long-term (Next Quarter):<a class="headerlink" href="#long-term-next-quarter" title="Permanent link">&para;</a></h3>
<ol>
<li>üîÆ <strong>Add distributed tracing</strong> for connection lifecycle</li>
<li>üîÆ <strong>Implement connection pool analytics</strong> dashboard</li>
<li>üîÆ <strong>Optimize pool size</strong> based on production metrics</li>
</ol>
<hr />
<h2 id="appendix-a-all-files-creating-neo4j-drivers">Appendix A: All Files Creating Neo4j Drivers<a class="headerlink" href="#appendix-a-all-files-creating-neo4j-drivers" title="Permanent link">&para;</a></h2>
<h3 id="production-code-3-files">Production Code (3 files):<a class="headerlink" href="#production-code-3-files" title="Permanent link">&para;</a></h3>
<ol>
<li><code>app/services/neo4j/product_search.py</code> - Main search service</li>
<li><code>app/services/search/strategies/vector_strategy.py</code> - Vector search (REDUNDANT)</li>
<li><code>app/services/search/components/component_service.py</code> - Uses dependency injection (GOOD)</li>
</ol>
<h3 id="test-files-17-files_1">Test Files (17+ files):<a class="headerlink" href="#test-files-17-files_1" title="Permanent link">&para;</a></h3>
<ol>
<li><code>check_specific_product.py</code></li>
<li><code>check_attribute_ruleset.py</code></li>
<li><code>test_competitor_fields.py</code></li>
<li><code>tests/manual/test_accessories_lucene.py</code></li>
<li><code>tests/e2e/test_complete_proactive_flow.py</code></li>
<li><code>tests/manual/test_pagination_response.py</code></li>
<li><code>tests/manual/test_torch_relationships.py</code></li>
<li><code>tests/manual/test_lucene_index_working.py</code></li>
<li><code>tests/manual/test_lucene_300a.py</code></li>
<li><code>tests/manual/test_torch_db.py</code></li>
<li><code>tests/manual/test_torch_fix_verified.py</code></li>
<li><code>tests/manual/test_local_neo4j.py</code></li>
<li><code>tests/manual/test_feeder_accessories_lucene_debug.py</code></li>
<li><code>tests/manual/test_feeder_accessories_db.py</code></li>
<li><code>tests/manual/test_smart_search_direct.py</code></li>
<li><code>tests/manual/test_torch_search_issue.py</code></li>
<li><code>tests/manual/test_api_weighted_search.py</code></li>
<li><code>tests/manual/test_interconnector_db.py</code></li>
<li><code>tests/manual/test_accessory_categories.py</code></li>
<li><code>tests/manual/test_max_300a_query.py</code></li>
<li><code>tests/manual/test_torch_category_name.py</code></li>
</ol>
<hr />
<p><strong>End of Audit Report</strong></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 ESAB
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/esab/configurator" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/esab-configurator/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "toc.integrate", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="../../javascripts/extra.js"></script>
      
    
  </body>
</html>