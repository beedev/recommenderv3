# ============================================================================
# ESAB Recommender V2 - Docker Compose (Production)
# Production deployment with cloud databases (Neo4j Aura, Azure PostgreSQL)
# Local services: Backend API, Redis Cache, and RedisInsight (monitoring)
# ============================================================================

# Load environment variables from src/backend/.env
# The .env file should contain cloud database connection details:
# - NEO4J_URI (bolt+s://your-neo4j-aura.databases.neo4j.io)
# - NEO4J_USERNAME, NEO4J_PASSWORD
# - POSTGRES_HOST, POSTGRES_PORT, POSTGRES_USER, POSTGRES_PASSWORD
# - OPENAI_API_KEY
# - SECRET_KEY, JWT_SECRET_KEY
#
services:
  # ==========================================================================
  # Backend API Service (Production)
  # ==========================================================================
  backend:
    build:
      context: ../../
      dockerfile: deployment/docker/Dockerfile
    image: esab-recommender:${VERSION:-latest}
    container_name: esab-backend-prod
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    # Load environment variables from src/backend/.env
    env_file:
      - ../../src/backend/.env
    environment:
      # API Configuration
      - ENVIRONMENT=production
      - DEBUG=False
      # Redis Configuration (Local)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-esab_redis_prod_password}
      - REDIS_DB=${REDIS_DB:-0}
      - ENABLE_REDIS_CACHING=true
      - CACHE_TTL=${CACHE_TTL:-3600}
      # LangSmith (Optional)
      - LANGSMITH_PROJECT=${LANGSMITH_PROJECT:-Recommender-Prod}
      - LANGSMITH_TRACING=${LANGSMITH_TRACING:-false}
      # Note: Neo4j, PostgreSQL, OpenAI, and Security keys come from .env file
      # Do NOT override these variables here - they are loaded from src/backend/.env
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - esab-network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # ==========================================================================
  # Redis Cache (Session Storage - Local)
  # Neo4j Aura and Azure PostgreSQL are configured in .env file
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: esab-redis-prod
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-esab_redis_prod_password}
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
      --save 900 1
      --save 300 10
      --save 60 10000
    networks:
      - esab-network
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1.5G
        reservations:
          cpus: '0.25'
          memory: 512M

  # ==========================================================================
  # RedisInsight (Redis Management UI - Optional)
  # ==========================================================================
  redisinsight:
    image: redislabs/redisinsight:latest
    container_name: esab-redisinsight-prod
    user: "1000:1000"  # Add this line - use your user's UID/GID
    ports:
      - "${REDISINSIGHT_PORT:-8001}:8001"
    volumes:
      - redisinsight-data:/db
    networks:
      - esab-network
    restart: unless-stopped
    depends_on:
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

# ==============================================================================
# Named Volumes for Data Persistence
# ==============================================================================
volumes:
  redis-data:
    name: esab-redis-data-prod
  redisinsight-data:
    name: esab-redisinsight-data-prod

# ==============================================================================
# Custom Network
# ==============================================================================
networks:
  esab-network:
    name: esab-network-prod
    driver: bridge
